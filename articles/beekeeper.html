<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="beekeeper">
<title>Building an API Package • beekeeper</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Building an API Package">
<meta property="og:description" content="beekeeper">
<meta property="og:image" content="https://beekeeper.api2r.org/logo.svg">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">beekeeper</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/beekeeper.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/jonthegeek/beekeeper/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Building an API Package</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jonthegeek/beekeeper/blob/HEAD/vignettes/beekeeper.Rmd" class="external-link"><code>vignettes/beekeeper.Rmd</code></a></small>
      <div class="d-none name"><code>beekeeper.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://beekeeper.api2r.org">beekeeper</a></span><span class="op">)</span></span></code></pre></div>
<p>The goal of beekeeper is to streamline and standardize the creation
of high-quality API-wrapper packages.</p>
<p>The process works best for APIs that follow the <a href="https://spec.openapis.org/oas/v3.0.0" class="external-link">OpenAPI Specification</a>
(the “OAS”). Some APIs that follow the OAS can be found on <a href="https://apis.guru/" class="external-link">APIs.guru</a>. We will use the <a href="https://api.apis.guru/v2/openapi.yaml" class="external-link">APIs.guru API</a> (no
authentication) and the <a href="https://api.apis.guru/v2/specs/fec.gov/1.0/openapi.yaml" class="external-link">OpenFEC
API</a> (authentication using an API key) as examples.</p>
<div class="section level2">
<h2 id="step-0-create-your-package">Step 0: Create your package<a class="anchor" aria-label="anchor" href="#step-0-create-your-package"></a>
</h2>
<p>To start, first create a package. We recommend that you start with
<code><a href="https://usethis.r-lib.org/reference/create_package.html" class="external-link">usethis::create_package()</a></code> to streamline the general
package-creation steps.</p>
<p>You can then get basic API calls working in that package through a
two-step process.</p>
</div>
<div class="section level2">
<h2 id="step-1-configure-your-package">Step 1: Configure your package<a class="anchor" aria-label="anchor" href="#step-1-configure-your-package"></a>
</h2>
<p>If your target API follows the OAS, you can use your API’s OpenAPI
Document to configure your package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Note: Running these commands will create or overwrite "_beekeeper.yml" in your</span></span>
<span><span class="co"># working directory.</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"https://api.apis.guru/v2/openapi.yaml"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/use_beekeeper.html">use_beekeeper</a></span><span class="op">(</span></span>
<span>    api_abbr <span class="op">=</span> <span class="st">"guru"</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Or for the FEC</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/connections.html" class="external-link">url</a></span><span class="op">(</span><span class="st">"https://api.apis.guru/v2/specs/fec.gov/1.0/openapi.yaml"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="../reference/use_beekeeper.html">use_beekeeper</a></span><span class="op">(</span></span>
<span>    api_abbr <span class="op">=</span> <span class="st">"fec"</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="step-2-generate-your-package-skeleton">Step 2: Generate your package skeleton<a class="anchor" aria-label="anchor" href="#step-2-generate-your-package-skeleton"></a>
</h2>
<p>With a valid <code>_beekeeper.yml</code> file, you can generate the
rest of the package. Right now the package will only export a function
to call the API, but eventually this process will also generate
functions for the endpoints specified in the API’s OpenAPI document.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Note: Running this command will create or overwrite files in your R and</span></span>
<span><span class="co"># tests/testthat directories.</span></span>
<span><span class="fu"><a href="../reference/generate_pkg.html">generate_pkg</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><code><a href="../reference/generate_pkg.html">generate_pkg()</a></code> creates files defining the package in the
<code>R</code> directory, and tests in the <code>tests/testthat</code>
directory.</p>
</div>
<div class="section level2">
<h2 id="the-generated-package">The generated package<a class="anchor" aria-label="anchor" href="#the-generated-package"></a>
</h2>
<div class="section level3">
<h3 id="call-r">010-call.R<a class="anchor" aria-label="anchor" href="#call-r"></a>
</h3>
<p>The main file generated for the package is <code>R/010-call.R</code>.
This file defines a function that can be used to call the API.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#' Call the OpenFEC API</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' Generate a request to an OpenFEC endpoint.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @inheritParams nectar::call_api</span></span>
<span><span class="co">#' @param api_key An API key provided by the API provider. This key is not</span></span>
<span><span class="co">#'   clearly documented in the API description. Check the API documentation for</span></span>
<span><span class="co">#'   details.</span></span>
<span><span class="co">#'</span></span>
<span><span class="co">#' @return The response from the endpoint.</span></span>
<span><span class="co">#' @export</span></span>
<span><span class="va">fec_call_api</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">path</span>,</span>
<span>                         <span class="va">query</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                         <span class="va">body</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                         <span class="va">method</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                         <span class="va">api_key</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"FEC_API_KEY"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">nectar</span><span class="fu">::</span><span class="fu"><a href="https://nectar.api2r.org/reference/call_api.html" class="external-link">call_api</a></span><span class="op">(</span></span>
<span>    base_url <span class="op">=</span> <span class="st">"https://api.open.fec.gov/v1"</span>,</span>
<span>    path <span class="op">=</span> <span class="va">path</span>,</span>
<span>    query <span class="op">=</span> <span class="va">query</span>,</span>
<span>    body <span class="op">=</span> <span class="va">body</span>,</span>
<span>    method <span class="op">=</span> <span class="va">method</span>,</span>
<span>    user_agent <span class="op">=</span> <span class="st">"fecapi (https://github.com/jonthegeek/fecapi)"</span>,</span>
<span>    security_fn <span class="op">=</span> <span class="va">fec_security</span>,</span>
<span>    security_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>api_key <span class="op">=</span> <span class="va">api_key</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Notice that the function includes API-key security arguments when
appropriate!</p>
</div>
<div class="section level3">
<h3 id="security-r">020-security.R<a class="anchor" aria-label="anchor" href="#security-r"></a>
</h3>
<p>Security for the API is defined in <code>R/020-security.R</code>. The
initial version of this file works, but you may want to edit the
automatic output. In the case of the OpenFEC API, the description
specifies three security schemes that overlap with one another: two that
set an <code>api_key</code> in the query string, and one that sets an
<code>X-Api-Key</code> field in the header.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># These functions were generated by the {beekeeper} package, based on</span></span>
<span><span class="co"># components@security_schemes from the source API description. You may want to</span></span>
<span><span class="co"># delete unused options. In addition, APIs often have additional security</span></span>
<span><span class="co"># options that are not formally documented in the API description. For example,</span></span>
<span><span class="co"># for any `location = query` `api_key` options, it might be possible to instead</span></span>
<span><span class="co"># pass the same parameter in a header, possibly with a different name. Consult</span></span>
<span><span class="co"># the text description of authentication in your API documentation.</span></span>
<span></span>
<span><span class="va">fec_security</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">api_key</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">req</span> <span class="op">&lt;-</span> <span class="fu">fec_security_api_key_header_auth</span><span class="op">(</span><span class="va">req</span>, <span class="va">api_key</span><span class="op">)</span></span>
<span>  <span class="va">req</span> <span class="op">&lt;-</span> <span class="fu">fec_security_api_key_query_auth</span><span class="op">(</span><span class="va">req</span>, <span class="va">api_key</span><span class="op">)</span></span>
<span>  <span class="va">req</span> <span class="op">&lt;-</span> <span class="fu">fec_security_api_key</span><span class="op">(</span><span class="va">req</span>, <span class="va">api_key</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">req</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># An API key provided by the API provider. This key is not clearly documented in</span></span>
<span><span class="co"># the API description. Check the API documentation for details.</span></span>
<span><span class="va">fec_security_api_key_header_auth</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">api_key</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">nectar</span><span class="fu">::</span><span class="fu"><a href="https://nectar.api2r.org/reference/security_api_key.html" class="external-link">security_api_key</a></span><span class="op">(</span></span>
<span>    <span class="va">req</span>,</span>
<span>    location <span class="op">=</span> <span class="st">"header"</span>,</span>
<span>    parameter_name <span class="op">=</span> <span class="st">"X-Api-Key"</span>,</span>
<span>    api_key <span class="op">=</span> <span class="va">api_key</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># An API key provided by the API provider. This key is not clearly documented in</span></span>
<span><span class="co"># the API description. Check the API documentation for details.</span></span>
<span><span class="va">fec_security_api_key_query_auth</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">api_key</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">nectar</span><span class="fu">::</span><span class="fu"><a href="https://nectar.api2r.org/reference/security_api_key.html" class="external-link">security_api_key</a></span><span class="op">(</span></span>
<span>    <span class="va">req</span>,</span>
<span>    location <span class="op">=</span> <span class="st">"query"</span>,</span>
<span>    parameter_name <span class="op">=</span> <span class="st">"api_key"</span>,</span>
<span>    api_key <span class="op">=</span> <span class="va">api_key</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># An API key provided by the API provider. This key is not clearly documented in</span></span>
<span><span class="co"># the API description. Check the API documentation for details.</span></span>
<span><span class="va">fec_security_api_key</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">req</span>, <span class="va">api_key</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">nectar</span><span class="fu">::</span><span class="fu"><a href="https://nectar.api2r.org/reference/security_api_key.html" class="external-link">security_api_key</a></span><span class="op">(</span></span>
<span>    <span class="va">req</span>,</span>
<span>    location <span class="op">=</span> <span class="st">"query"</span>,</span>
<span>    parameter_name <span class="op">=</span> <span class="st">"api_key"</span>,</span>
<span>    api_key <span class="op">=</span> <span class="va">api_key</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>For the real package, I deleted the two <code>query</code> functions,
since the <code>header</code> function is sufficient and slightly more
secure.</p>
</div>
<div class="section level3">
<h3 id="test-files">test files<a class="anchor" aria-label="anchor" href="#test-files"></a>
</h3>
<p>The generated package also includes tests for the API. If you have
not already done so, it also activates the use of
<a href="https://testthat.r-lib.org" class="external-link">testthat</a> in the package.</p>
<p>To test the overall functionality of the package, provide an endpoint
path in <code>tests/testthat/test-010-call.R</code>. A future version of
<a href="https://beekeeper.api2r.org">beekeeper</a> will attempt to auto-fill this path for
you.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">httptest2</span><span class="fu">::</span><span class="fu"><a href="https://enpiar.com/httptest2/reference/with_mock_dir.html" class="external-link">with_mock_dir</a></span><span class="op">(</span><span class="st">"api/01-call/valid"</span>, <span class="op">{</span></span>
<span>  <span class="fu">test_that</span><span class="op">(</span><span class="st">"Can call an endpoint without errors"</span>, <span class="op">{</span></span>
<span>    <span class="co"># A path will be auto-filled in a future version of beekeeper.</span></span>
<span>    <span class="fu">fail</span><span class="op">(</span></span>
<span>      <span class="st">"Provide any path for this API in PROVIDED_PATH, then delete this fail."</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">PROVIDED_PATH</span> <span class="op">&lt;-</span> <span class="st">"path/to/endpoint"</span></span>
<span>    <span class="fu">expect_no_error</span><span class="op">(</span><span class="fu">fec_call_api</span><span class="op">(</span><span class="va">PROVIDED_PATH</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>Manually edited to:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">httptest2</span><span class="fu">::</span><span class="fu"><a href="https://enpiar.com/httptest2/reference/with_mock_dir.html" class="external-link">with_mock_dir</a></span><span class="op">(</span><span class="st">"api/01-call/valid"</span>, <span class="op">{</span></span>
<span>  <span class="fu">test_that</span><span class="op">(</span><span class="st">"Can call an endpoint without errors"</span>, <span class="op">{</span></span>
<span>    <span class="va">PROVIDED_PATH</span> <span class="op">&lt;-</span> <span class="st">"candidates"</span></span>
<span>    <span class="fu">expect_no_error</span><span class="op">(</span><span class="fu">fec_call_api</span><span class="op">(</span><span class="va">PROVIDED_PATH</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<p>You may also want to add specific tests for endpoints that require
authentication vs endpoints that do not require authentication. A future
version of <a href="https://beekeeper.api2r.org">beekeeper</a> will attempt to auto-generate such
tests when appropriate (when different paths use different security
schemes).</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Jon Harmon, R Consortium.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
